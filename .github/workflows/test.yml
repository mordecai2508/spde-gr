name: Run Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout del repositorio
        uses: actions/checkout@v3

      # -----------------------------------------------------
      # 1️⃣ Instalar dependencias de Docker, Kind y kubectl
      # -----------------------------------------------------
      - name: 🔧 Instalar Kind y kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      # -----------------------------------------------------
      # 2️⃣ Crear un clúster temporal de Kubernetes
      # -----------------------------------------------------
      - name: 🌐 Crear clúster Kind
        run: kind create cluster --name spde-cluster

      # -----------------------------------------------------
      # 3️⃣ Construir imágenes Docker locales
      # -----------------------------------------------------
      - name: 🏗️ Construir imágenes Docker
        run: |
          docker build -t spde-backend:latest ./backend
          docker build -t spde-frontend:latest ./frontend

      # -----------------------------------------------------
      # 4️⃣ Cargar imágenes locales al clúster Kind
      # -----------------------------------------------------
      - name: 📦 Cargar imágenes al clúster Kind
        run: |
          kind load docker-image spde-backend:latest --name spde-cluster
          kind load docker-image spde-frontend:latest --name spde-cluster

      # -----------------------------------------------------
      # 5️⃣ Aplicar manifiestos de Kubernetes
      # -----------------------------------------------------
      - name: 🚀 Aplicar manifiestos de Kubernetes
        run: |
          kubectl apply -f k8s/
          echo "Esperando que los pods estén listos..."
          kubectl wait --for=condition=available --timeout=180s deployment/spde-backend
          kubectl wait --for=condition=available --timeout=180s deployment/spde-frontend
          kubectl get pods -A

      # -----------------------------------------------------
      # 6️⃣ Instalar dependencias y ejecutar pruebas backend
      # -----------------------------------------------------
      - name: 🧩 Instalar dependencias Backend
        run: |
          cd backend
          npm install

      - name: 🧪 Ejecutar pruebas Backend
        run: |
          cd backend
          npm test

      # -----------------------------------------------------
      # 7️⃣ Instalar dependencias y ejecutar pruebas frontend
      # -----------------------------------------------------
      - name: 💻 Instalar dependencias Frontend
        run: |
          cd frontend
          npm install

      - name: 🧠 Ejecutar pruebas Frontend
        run: |
          cd frontend
          npm run test --if-present

      # -----------------------------------------------------
      # 8️⃣ Eliminar clúster Kind (limpieza)
      # -----------------------------------------------------
      - name: 🧹 Eliminar clúster Kind
        if: always()
        run: kind delete cluster --name spde-cluster

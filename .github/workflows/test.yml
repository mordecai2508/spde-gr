name: Run Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout del repositorio
        uses: actions/checkout@v3

      # -----------------------------------------------------
      # 1ï¸âƒ£ Instalar dependencias de Docker, Kind y kubectl
      # -----------------------------------------------------
      - name: ğŸ”§ Instalar Kind y kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      # -----------------------------------------------------
      # 2ï¸âƒ£ Crear un clÃºster temporal de Kubernetes
      # -----------------------------------------------------
      - name: ğŸŒ Crear clÃºster Kind
        run: kind create cluster --name spde-cluster

      # -----------------------------------------------------
      # 3ï¸âƒ£ Construir imÃ¡genes Docker locales
      # -----------------------------------------------------
      - name: ğŸ—ï¸ Construir imÃ¡genes Docker
        run: |
          docker build -t spde-backend:latest ./backend
          docker build -t spde-frontend:latest ./frontend

      # -----------------------------------------------------
      # 4ï¸âƒ£ Cargar imÃ¡genes locales al clÃºster Kind
      # -----------------------------------------------------
      - name: ğŸ“¦ Cargar imÃ¡genes al clÃºster Kind
        run: |
          kind load docker-image spde-backend:latest --name spde-cluster
          kind load docker-image spde-frontend:latest --name spde-cluster

      # -----------------------------------------------------
      # 5ï¸âƒ£ Aplicar manifiestos de Kubernetes
      # -----------------------------------------------------
      - name: ğŸš€ Aplicar manifiestos de Kubernetes
        run: |
          kubectl apply -f k8s/
          echo "Esperando que los pods estÃ©n listos..."
          kubectl wait --for=condition=available --timeout=180s deployment/spde-backend
          kubectl wait --for=condition=available --timeout=180s deployment/spde-frontend
          kubectl get pods -A

      # -----------------------------------------------------
      # 6ï¸âƒ£ Instalar dependencias y ejecutar pruebas backend
      # -----------------------------------------------------
      - name: ğŸ§© Instalar dependencias Backend
        run: |
          cd backend
          npm install

      - name: ğŸ§ª Ejecutar pruebas Backend
        run: |
          cd backend
          npm test

      # -----------------------------------------------------
      # 7ï¸âƒ£ Instalar dependencias y ejecutar pruebas frontend
      # -----------------------------------------------------
      - name: ğŸ’» Instalar dependencias Frontend
        run: |
          cd frontend
          npm install

      - name: ğŸ§  Ejecutar pruebas Frontend
        run: |
          cd frontend
          npm run test --if-present

      # -----------------------------------------------------
      # 8ï¸âƒ£ Eliminar clÃºster Kind (limpieza)
      # -----------------------------------------------------
      - name: ğŸ§¹ Eliminar clÃºster Kind
        if: always()
        run: kind delete cluster --name spde-cluster
